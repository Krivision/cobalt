name: Build Cobalt
description: Builds Cobalt targets
runs:
  using: "composite"
  steps:
    - name: Set up Cloud SDK
      if: startsWith(${{matrix.target_platform}}, 'android')
      uses: isarkis/setup-gcloud@40dce7857b354839efac498d3632050f568090b6 # v1.1.1
    - name: Set Android env vars
      if: startsWith(${{matrix.target_platform}}, 'android')
      run: |
        echo "ANDROID_HOME=/root/starboard-toolchains/AndroidSdk/" >> $GITHUB_ENV
        PROJECT_NAME=$(gcloud config get-value project)
        echo "GCS_NIGHTLY_PATH=gs://${PROJECT_NAME}-build-artifacts" >> $GITHUB_ENV
      shell: bash
    - name: Build
      run: |
        set -x
        env
        if [ -z ${COBALT_EVERGREEN_LOADER+x} ]; then
          BUILD_PLATFORM="${{ matrix.target_platform }}"
          BUILD_TARGET="default"
          if [[ "${{ matrix.config }}" =~ ^(debug|devel)$ ]]; then
            BUILD_TARGET="all"
          fi
        else
          # TODO: We should build evergreen compat targets here too.
          # nplb_evergreen_loader_install
          # nplb_evergreen_compat_tests_evergreen_loader_install

          BUILD_PLATFORM="${COBALT_EVERGREEN_LOADER}"
          BUILD_TARGET="loader_app_install elf_loader_sandbox_install native_target/crashpad_handler"

          # TODO(todo): Use gn to query for targets.
          # Specify build targets for EG AOSP loader build.
          if [[ "${BUILD_PLATFORM}" == "android-arm" && "${{ matrix.config }}" =~ ^(debug|devel)$ ]]; then
            BUILD_TARGET="${BUILD_TARGET} \
                          audio_test \
                          base_unittests \
                          base_test \
                          bindings_test \
                          browser_test \
                          components_metrics_tests \
                          crypto_impl_test \
                          crypto_unittests \
                          csp_test \
                          cssom_test \
                          css_parser_test \
                          cwrappers_test \
                          dom_parser_test \
                          dom_test \
                          extension_test \
                          graphics_system_test \
                          js_profiler_test \
                          layout_test \
                          layout_tests \
                          loader_test \
                          math_test \
                          media_capture_test \
                          media_session_test \
                          media_stream_test \
                          media_test \
                          memory_store_test \
                          metrics_test \
                          network_test \
                          net_unittests \
                          overlay_info_test \
                          persistent_settings_test \
                          png_utils_test \
                          render_tree_test \
                          renderer_test \
                          scroll_engine_tests \
                          speech_test \
                          storage_test \
                          text_encoding_test \
                          watchdog_test \
                          web_animations_test \
                          webdriver_test \
                          web_test \
                          websocket_test \
                          worker_test \
                          xhr_test \
                          zip_unittests"
            BUILD_TARGET_INSTALL="audio_test_evergreen_loader_install \
                                  base_unittests_evergreen_loader_install \
                                  base_test_evergreen_loader_install \
                                  bindings_test_evergreen_loader_install \
                                  browser_test_evergreen_loader_install \
                                  components_metrics_tests_evergreen_loader_install \
                                  crypto_impl_test_evergreen_loader_install \
                                  crypto_unittests_evergreen_loader_install \
                                  csp_test_evergreen_loader_install \
                                  cssom_test_evergreen_loader_install \
                                  css_parser_test_evergreen_loader_install \
                                  cwrappers_test_evergreen_loader_install \
                                  dom_parser_test_evergreen_loader_install \
                                  dom_test_evergreen_loader_install \
                                  extension_test_evergreen_loader_install \
                                  graphics_system_test_evergreen_loader_install \
                                  js_profiler_test_evergreen_loader_install \
                                  layout_test_evergreen_loader_install \
                                  layout_tests_evergreen_loader_install \
                                  loader_test_evergreen_loader_install \
                                  math_test_evergreen_loader_install \
                                  media_capture_test_evergreen_loader_install \
                                  media_session_test_evergreen_loader_install \
                                  media_stream_test_evergreen_loader_install \
                                  media_test_evergreen_loader_install \
                                  memory_store_test_evergreen_loader_install \
                                  metrics_test_evergreen_loader_install \
                                  network_test_evergreen_loader_install \
                                  net_unittests_evergreen_loader_install \
                                  overlay_info_test_evergreen_loader_install \
                                  persistent_settings_test_evergreen_loader_install \
                                  png_utils_test_evergreen_loader_install \
                                  render_tree_test_evergreen_loader_install \
                                  renderer_test_evergreen_loader_install \
                                  scroll_engine_tests_evergreen_loader_install \
                                  speech_test_evergreen_loader_install \
                                  storage_test_evergreen_loader_install \
                                  text_encoding_test_evergreen_loader_install \
                                  watchdog_test_evergreen_loader_install \
                                  web_animations_test_evergreen_loader_install \
                                  webdriver_test_evergreen_loader_install \
                                  web_test_evergreen_loader_install \
                                  websocket_test_evergreen_loader_install \
                                  worker_test_evergreen_loader_install \
                                  xhr_test_evergreen_loader_install \
                                  zip_unittests_evergreen_loader_install"
          fi
        fi

        # TODO(todo): Adapt image to GitHub and remove this.
        # GitHub Runners have home set to /github/home.
        if [ -d /root/starboard-toolchains ]; then
          ln -s /root/starboard-toolchains /github/home/starboard-toolchains
        fi

        # Set Ninja output format.
        NINJA_STATUS="[%e sec | %f/%t %u remaining | %c/sec | j%r] "

        # TODO(todo): Half workers for EG AOSP build as it runs out of memory while building.
        if [[ -n ${COBALT_EVERGREEN_LOADER} && "${BUILD_PLATFORM}" == "android-arm" ]]; then
          ninja -C ${GITHUB_WORKSPACE}/out/${BUILD_PLATFORM}_${{matrix.config}} ${BUILD_TARGET}
          ninja -j 1 -C ${GITHUB_WORKSPACE}/out/${BUILD_PLATFORM}_${{matrix.config}} ${BUILD_TARGET_INSTALL}
        else
          ninja -C ${GITHUB_WORKSPACE}/out/${BUILD_PLATFORM}_${{matrix.config}} ${BUILD_TARGET}
        fi

      shell: bash
    - name: Show Sccache Stats
      run: sccache -s
      shell: bash
